<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ux_client_script">
    <sys_ux_client_script action="INSERT_OR_UPDATE">
        <controller_preset/>
        <includes/>
        <macroponent display_value="Default">534ad6883b6e3a10bc1ccdd643e45ac7</macroponent>
        <name>Submit Create Coordinator</name>
        <preset/>
        <required_translations>[]</required_translations>
        <script><![CDATA[/**
 * @param {params} params
 * @param {api} params.api
 * @param {any} params.event
 * @param {any} params.imports
 * @param {ApiHelpers} params.helpers
 */
function handler({ api, event, helpers, imports }) {
  api.setState('isCoordinatorSubmitted', true);

  var item = api.state.coordinatorItem;     // ฟอร์มที่กำลังกรอก
  var coordinators = api.state.coordinator; // array สะสม

  if (!Array.isArray(coordinators)) {
    coordinators = [];
  }

  var requiredKeys = [
    'email',
    'first_name_th',
    'last_name_th',
    'mobile_no',
    'title_name'
  ];

  function isEmpty(v) {
    return v === null || v === undefined || (typeof v === 'string' && v.trim() === '');
  }

  var isValid = true;

  // validate item เดียว
  if (!item || typeof item !== 'object') {
    isValid = false;
  } else {
    for (var i = 0; i < requiredKeys.length; i++) {
      if (isEmpty(item[requiredKeys[i]])) {
        isValid = false;
        break;
      }
    }
  }

  if (!isValid) {
    console.log('not yet completed');
    return;
  }

  // =========================
  // ✅ ผ่านครบทุก field
  // =========================
  console.log('completed');

  // ❗ กันซ้ำด้วย email (สำคัญมาก)
  var exists = coordinators.some(function (c) {
    return c && c.email === item.email;
  });

  if (!exists) {
    coordinators.push(Object.assign({}, item)); // clone กัน state เพี้ยน
    api.setState('coordinator', coordinators);
  }

 
  api.setState('isCoordinatorSubmitted', false);

  // ปิด modal
  api.emit('MODAL_SELECTED', {
    modalId: 'coordinator_modal',
    showModal: false
  });

   // reset form
  api.setState('coordinatorItem', {
    email: '',
    first_name_th: '',
    last_name_th: '',
    mobile_no: '',
    title_name: ''
  });

}
]]></script>
        <script_api_version>2.0.0</script_api_version>
        <sys_class_name>sys_ux_client_script</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-01-21 07:35:31</sys_created_on>
        <sys_id>69f9d0c63beaf650bc1ccdd643e45ac9</sys_id>
        <sys_mod_count>8</sys_mod_count>
        <sys_name>Submit Create Coordinator</sys_name>
        <sys_package display_value="BOT Application" source="x_1896436_bot_ap_0">566dc70e3b527210bc1ccdd643e45a0f</sys_package>
        <sys_policy/>
        <sys_scope display_value="BOT Application">566dc70e3b527210bc1ccdd643e45a0f</sys_scope>
        <sys_update_name>sys_ux_client_script_69f9d0c63beaf650bc1ccdd643e45ac9</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-01-21 10:16:35</sys_updated_on>
        <target>macroponent</target>
        <type>default</type>
    </sys_ux_client_script>
</record_update>
